# Schema Synchronization System

This document explains how to use the schema synchronization system to keep Python schemas in sync with the Supabase database.

## Overview

The schema sync system ensures that your local Python TypedDict definitions and Enum classes accurately reflect the current state of your Supabase database schema. This prevents runtime errors caused by schema drift and maintains type safety across your application.

## Components

### 1. `scripts/sync_schema.py`

The main CLI tool that queries Supabase, compares schemas, and updates local files.

### 2. `schemas/schema_version.py`

Tracks the current schema version, last sync time, and database hash. Auto-generated by sync script.

### 3. `.github/workflows/schema-check.yml`

GitHub Action that automatically checks for schema drift on pull requests and scheduled runs.

## Usage

### Check for Schema Drift

Check if local schemas match the database without making changes:

```bash
python scripts/sync_schema.py --check
```

This command:
- Queries the Supabase database schema
- Compares with local Python schema files
- Exits with code 1 if drift is detected
- Perfect for CI/CD pipelines

**Exit codes:**
- `0`: No drift detected (schemas in sync)
- `1`: Drift detected (action required)

### Show Detailed Differences

View a human-readable diff of schema changes:

```bash
python scripts/sync_schema.py --diff
```

This displays:
- New/removed enums and their values
- New/removed tables and columns
- Modified enums (added/removed values)
- Modified tables (added/removed columns)
- Severity level for each change (critical, high, medium, low)

**Example output:**
```
[HIGH] ENUM: project_status
  Change: modified
  Added values: pending, on_hold
  Removed values: draft

[MEDIUM] TABLE: organizations
  Change: modified
  Added columns: billing_cycle, max_members
```

### Update Local Schemas

Automatically update local schema files to match the database:

```bash
python scripts/sync_schema.py --update
```

This command:
- Detects all schema differences
- Generates Python code for new enums and tables
- Updates `schema_version.py` with new hash and timestamp
- Outputs code snippets that need manual integration

**Note:** Due to the complexity of code merging, some updates require manual integration. The script will output the necessary code snippets.

### Generate a Report

Create a detailed Markdown report of schema changes:

```bash
python scripts/sync_schema.py --report
```

This generates a timestamped report file like `schema_drift_report_20251009_153045.md` containing:
- Summary of all differences
- Categorized changes (enums, tables)
- Recommended actions
- Perfect for documentation and team communication

### Specify Project ID

Override the default Supabase project ID:

```bash
python scripts/sync_schema.py --check --project-id prj_abc123
```

Without this flag, the project ID is read from `SUPABASE_PROJECT_ID` environment variable.

## What to Do When Drift is Detected

When schema drift is detected, follow these steps:

### 1. Review the Changes

```bash
# See detailed differences
python scripts/sync_schema.py --diff

# Generate full report for documentation
python scripts/sync_schema.py --report
```

### 2. Understand the Impact

Analyze each difference for breaking changes:

- **Critical Severity**: Removed enums/tables (breaking change)
- **High Severity**: Modified enums, removed columns (potential breaking change)
- **Medium Severity**: Added columns, modified non-critical fields
- **Low Severity**: Minor additions

### 3. Update Local Schemas

```bash
python scripts/sync_schema.py --update
```

This will:
- Generate code for new enums and tables
- Update `schema_version.py`
- Provide code snippets for manual integration

### 4. Manually Integrate Changes

For each code snippet provided:

#### New Enums
Copy the generated enum class into `schemas/enums.py`:

```python
# Generated code:
class ProjectStatusType(str, Enum):
    """project_status enumeration - Auto-generated"""
    ACTIVE = "active"
    PENDING = "pending"
    ON_HOLD = "on_hold"
```

#### New Tables
Copy the generated TypedDict into the appropriate file:
- Entity tables → `schemas/database/entities.py`
- Relationship tables → `schemas/database/relationships.py`

```python
# Generated code:
class NewTableRow(TypedDict, total=False):
    """Database row for new_table"""
    id: str
    name: str
    created_at: str
```

#### Modified Tables
Update existing TypedDict definitions to add new columns or remove deprecated ones.

### 5. Update Application Code

Search for usages of changed schemas:

```bash
# Find usages of a specific enum
grep -r "ProjectStatus" --include="*.py"

# Find usages of a table
grep -r "OrganizationRow" --include="*.py"
```

Update any code that depends on:
- Removed enum values
- Removed table columns
- Changed column types

### 6. Run Tests

```bash
# Run full test suite
pytest

# Run specific tests related to changed schemas
pytest tests/test_entity_tool*.py
pytest tests/test_query_tool*.py
```

### 7. Commit Changes

```bash
git add schemas/
git commit -m "chore: sync schemas with database

- Add new ProjectStatus enum values
- Update OrganizationRow with billing fields
- Remove deprecated fields from RequirementRow"
```

## CI/CD Integration

### GitHub Actions

The schema check workflow automatically runs on:
- **Pull Requests**: Validates schema sync before merging
- **Schedule**: Daily at 9 AM UTC to catch manual database changes
- **Manual Trigger**: Via workflow_dispatch

#### On Pull Requests

When drift is detected:
1. Workflow fails with descriptive error
2. Drift report is uploaded as artifact
3. Comment is posted on PR with details
4. PR cannot merge until drift is resolved

#### On Schedule

Daily checks notify team of:
- Manual database changes
- Migration scripts not reflected in code
- Configuration drift

### Pre-commit Hook

Add a pre-commit hook to catch drift before pushing:

```bash
# .git/hooks/pre-commit
#!/bin/bash
python scripts/sync_schema.py --check
if [ $? -ne 0 ]; then
    echo "Schema drift detected! Run 'python scripts/sync_schema.py --diff' for details"
    exit 1
fi
```

### CI/CD Pipeline Integration

```yaml
# Example: .gitlab-ci.yml
schema-check:
  script:
    - pip install -r requirements.txt
    - python scripts/sync_schema.py --check
  only:
    - merge_requests
    - main
```

## Testing Strategy

### 1. Unit Tests for Schema Sync Tool

Test the sync tool itself:

```python
# tests/test_schema_sync.py
def test_enum_comparison():
    sync = SchemaSync()
    # Test enum comparison logic

def test_table_comparison():
    sync = SchemaSync()
    # Test table comparison logic
```

### 2. Integration Tests with Mock Database

Test against a mock database schema:

```python
def test_sync_with_mock_db():
    sync = SchemaSync()
    sync.db_schema = mock_schema
    differences = sync.compare_schemas()
    assert len(differences) == expected_count
```

### 3. Validation Tests

Ensure generated code is valid:

```python
def test_generated_enum_code():
    sync = SchemaSync()
    code = sync.generate_enum_code("test_enum", ["val1", "val2"])
    # Validate Python syntax
    compile(code, '<string>', 'exec')
```

### 4. End-to-End Tests

Test the full workflow:

```bash
# Test check mode
python scripts/sync_schema.py --check
assert $? -eq 0

# Test diff mode
python scripts/sync_schema.py --diff > diff.txt
assert [ -s diff.txt ]

# Test report generation
python scripts/sync_schema.py --report
assert [ -f schema_drift_report_*.md ]
```

## Best Practices

### 1. Run Checks Frequently

- Before committing code
- Before deploying
- After database migrations
- Daily via CI/CD

### 2. Keep Schema Files Organized

```
schemas/
├── __init__.py
├── schema_version.py        # Auto-generated version tracking
├── enums.py                 # All enum definitions
├── database/
│   ├── entities.py          # Entity table TypedDicts
│   └── relationships.py     # Relationship table TypedDicts
└── generated/
    └── fastapi/             # Auto-generated from supabase-pydantic
```

### 3. Document Breaking Changes

When making breaking schema changes:
1. Create a migration plan
2. Update schemas
3. Update dependent code
4. Add migration notes to commit message

### 4. Version Control Schema Changes

Always commit schema changes together with:
- Database migration scripts
- Updated Python schemas
- Updated tests
- Migration documentation

### 5. Use Type Hints Everywhere

Leverage the TypedDict definitions:

```python
from schemas.database.entities import OrganizationRow

def process_org(org: OrganizationRow) -> None:
    # Type-safe access to organization fields
    name: str = org['name']
    type_: str = org['type']
```

## Troubleshooting

### Issue: "Cannot connect to Supabase"

**Solution:** Ensure environment variables are set:
```bash
export SUPABASE_URL="https://xxx.supabase.co"
export SUPABASE_SERVICE_KEY="your-service-key"
export SUPABASE_PROJECT_ID="your-project-id"
```

### Issue: "Schema hash mismatch"

**Solution:** The database schema changed. Run:
```bash
python scripts/sync_schema.py --diff
```

### Issue: "Import errors after schema update"

**Solution:** Generated code may need manual adjustments:
1. Check Python syntax in generated code
2. Add missing imports
3. Resolve naming conflicts

### Issue: "False positives in drift detection"

**Solution:** Improve enum/table name mapping:
1. Update `_convert_class_to_enum_name()` method
2. Update `_convert_class_to_table_name()` method
3. Add special cases to mapping dictionaries

### Issue: "Type annotations not working"

**Solution:** Ensure proper imports:
```python
from typing import TypedDict, Optional
from schemas.enums import ProjectStatus
```

## Advanced Usage

### Custom Schema Comparison

Extend the `SchemaSync` class:

```python
class CustomSchemaSync(SchemaSync):
    def compare_schemas(self):
        # Add custom comparison logic
        differences = super().compare_schemas()
        # Add custom validations
        return differences
```

### Multiple Database Support

Check different databases:

```bash
# Production
python scripts/sync_schema.py --check --project-id prod_project

# Staging
python scripts/sync_schema.py --check --project-id staging_project
```

### Automated Schema Updates

Create a script for automated updates:

```bash
#!/bin/bash
# auto_sync.sh

python scripts/sync_schema.py --check
if [ $? -ne 0 ]; then
    python scripts/sync_schema.py --update
    git add schemas/
    git commit -m "chore: auto-sync schemas [skip ci]"
fi
```

## Schema Version History

Track schema evolution:

```python
from schemas.schema_version import SCHEMA_VERSION, LAST_SYNC, DB_HASH

print(f"Current schema version: {SCHEMA_VERSION}")
print(f"Last synced: {LAST_SYNC}")
print(f"Database hash: {DB_HASH}")
```

## Related Documentation

- [Supabase Schema Documentation](https://supabase.com/docs/guides/database)
- [TypedDict Documentation](https://docs.python.org/3/library/typing.html#typing.TypedDict)
- [Enum Documentation](https://docs.python.org/3/library/enum.html)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)

## Support

For issues or questions:
1. Check this documentation
2. Review generated reports
3. Examine workflow logs
4. Create an issue in the repository
